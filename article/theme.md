---
layout: post
title: "My blog theme: jekyll 'moving' theme with more features"
last_modified_at: 2022-11-23
---
My blog's repo: [github.com/willyywt/willyywt.github.io](https://github.com/willyywt/willyywt.github.io/) is forked from the jekkyll theme from [github.com/huangyz0918/moving](https://github.com/huangyz0918/moving/). As the time goes I tweak the theme to my liking and add a lot of features to it.

## Features
* A custom template forked from [huangyz0918/moving](https://github.com/huangyz0918/moving), heavily modified and enhanced
* Improved support for valid HTML 5 and several W3C standards, like [minimum contrast ratio](https://www.w3.org/TR/WCAG21/#contrast-minimum)
* Site viewable without JavaScript
* Using [modernizer.js](https://github.com/Modernizr/Modernizr) to do feature detection. **Warning: modernizr.com website is outdated, see github repo directly**
* Code highlight statically rendered with [rouge](https://kramdown.gettalong.org/syntax_highlighter/rouge.html)
* Code highlight use a custom CSS theme, inspired by the pygments vim theme
* Excerpt (first paragraph) shown for each post on home page
* Dark theme support
* Mobile devices support
* A custom "Site Preferences" page
* Font: Open Sans (sans-serif), Source Code Pro (monospace); can also replace with system font in "Site Preferences".
* A "Table of Contents" powered by [jekyll-toc](https://github.com/allejo/jekyll-toc/), written in pure [liquid](https://jekyllrb.com/docs/liquid/) syntax (no additional jekyll plugins required)
* Plugins included: [jekyll-feed](https://github.com/jekyll/jekyll-feed/), [jekyll-seo-tag](https://github.com/jekyll/jekyll-seo-tag), [jekyll-sitemap](https://github.com/jekyll/jekyll-sitemap)
* Website can also be hosted at a URL subdirectory, i.e. at a sub folder of a domain
* Link to source code file at page footer

## Simplify usage - fork your own
I originally used `remote_theme` but using `remote_theme` is not convenient when you need to override the original files: you cannot use git to view differences because `remote_theme` is not merged to your own repository.

Github pages can use custom theme in your repository, instead of using a `remote_theme`.  To use a github theme, you can fork the theme to your repository and directly change files in your own repository. If you want to update patches from the original theme simply do a git merge.

## Heavily changed index page
I changed the template for index page (home page) to my liking. The home page now includes a category summary, use black links instead of bluish ones, and shows an excerpt for each article.

## Table of Contents
A table of contents is automatically generated by [jekyll-toc](https://github.com/allejo/jekyll-toc/). This is entirely written in the [liquid](https://jekyllrb.com/docs/liquid/) templating language so it doesn't need additional jekyll plugins to work.

## Accent color
I used a series of redish accent colors for light and dark theme.

## Base font size
All font size are aligned to `rem` in unit size. The base font size is 17px.

### @media types
Some background knowledge of @media types:
> Media types describe the general category of a device. Except when using the not or only logical operators, the media type is optional and the all type is implied.
> [Media Query 4](https://drafts.csswg.org/mediaqueries/#media-types) defined three types: *all*, *print*, *screen*. Several additional types were defined in [Media Query 3](https://drafts.csswg.org/mediaqueries-3/#background) but are deprecated in Media Query 4.

Most querys use `@media (max-width: $on-large)`, instead of `@media screen and (max-width: $on-large)`, so such query also apply to print devices, like a PDF generator. However, CSS grid layout is only applied on screen devices.

See MDN [@media - Media Types](https://developer.mozilla.org/en-US/docs/Web/CSS/@media#media_types).

## Jekyll post
I took advantage of many builtin jekyll features (which wasn't in the original "moving" theme). Jekyll's documentation on jekyll post is at [Posts | Jekyll](https://jekyllrb.com/docs/posts/).

### Excerpt
Excerpt is also a jekyll's builtin feature. By default this will be the first paragraph (first `<p>` element) of your post. You can also explicitly designate a post's excerpt using the jekyll `excerpt` variable.

## Fix for Flash of unstyled content

According to [What the FOUC is happening: Flash of Unstyled Content](https://dev.to/lyqht/what-the-fouc-is-happening-flash-of-unstyled-content-413j), a trick to hide html can be used to prevent unstyled html to be shown. Because modern browsers load CSS sequentially, i.e. load CSS in the arriving order of html data, I can hide `<html>` at the first CSS stylesheet, load the needed stylesheets, and unhide `<html>` at the last CSS stylesheet:
```html
<head>
	<style>html{visibility: hidden;opacity:0;}</style>
	<script>
		/* load CSS here */
	</script>
	/* These are CSS loaded by javscript */
	<link id="maincss" rel="stylesheet" type="text/css" href="/assets/css/main.css" media="all">
	<link id="maincssshow" rel="stylesheet" type="text/css" href="/assets/css/unhide.css" media="all">
```
```css
/* /assets/css/unhide.css */
html {
    visibility: visible;
    opacity: 1;
}
```

## Dark mode
I merged a dark mode designed by Vel-San (but changed accent color). Repo: [github.com/Vel-San/moving darkmode](https://github.com/Vel-San/moving/tree/dark-mode), Vel-San's pull request to huangyz0918(unmerged): [UI Full Dark mode](https://github.com/huangyz0918/moving/pull/36)

Automatic detection of dark mode is enabled only when your browser return true for `window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches`. This basically means automatic detection of dark mode is only for modern browsers.

You can manually select dark mode at the "Site Preferences" link given at the header on the top. Not all browsers properly support this; for requirements see the [Preferences](#preferences) section below.

<div class="note warning"><b>Warning: </b>
As far as I know Windows 7 doesn't have dark mode at all; On Linux, chromium <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=998903">does not yet respond to gtk dark mode</a>. Chromium's commandline option <code>--force-dark-mode</code> can be used to force <code>(prefers-color-scheme: dark)</code> .
</div>

### Media query
Media query is one line away: `@media (prefers-color-scheme: light)`. Sass doesn't implement (re)defining sass variables under media query: you might expect sass to compile it to media queries but sass will simply error out.

I turned to a more monolithic approach: use javascript load different css stylesheet files depend on media query results. This is not optimal but I value compatibiliy for old browsers and for sass, and other approaches have issues that I can't undertake: I considered to use `@media (prefers-color-scheme: light)` and `@media (prefers-color-scheme: dark)` for this purpose (it can be added to `<link>` element `media` attribute), but this is not friendly to old browsers which do not support `prefers-color-scheme` at all (those browsers will not use any of these stylesheets). I also considered simutaneously loading the light and the dark stylesheet, but the problem is the light stylesheet can have rules not overlapping with the dark one, so I gave up on this approach. I think I should only load one of the light and the dark stylesheet.

### Remedy for white flashing at new page loading
<div class="note warning"><b>Warning: (Update 20221113)</b>
The correct way is to use <code>color-scheme</code> to silently pick up <code>@media (prefers-color-scheme)</code>:
<div><code>&lt;meta name="color-scheme" content="light dark" /&gt;</code></div>
</div>

When new page loads a white background is shown for a short period before the main css stylesheet loads, which is irritating for dark mode users.

Since dark mode is only provided for modern browsers, I can use a media query to (hopefully) remedy the white flashing:
```html
<style media="(prefers-color-scheme: dark)">html{background-color: black;}</style>
```

## Testing
### Test tools
Some hints for performance and user experience are provided by the LightHouse in chrome developer tools. I also use [W3C validator](https://validator.w3.org/) to check valid HTML 5.

### Tested browsers
Mostly I will just test on latest Firefox and Chromium. Occasionally I test on a few obsolete browsers: an IE 9 on Windows 7, a Safari on an iPad 2, and a proprietary browser on Android 4.2.

## Move font to local
Download font locally: [Google Webfonts helper](https://google-webfonts-helper.herokuapp.com/fonts)

## Code highlight
I use kramdown's builtin [rouge](https://kramdown.gettalong.org/syntax_highlighter/rouge.html) instead of [highlight.js](https://highlightjs.org/). A matching highlight css theme is in `/_sass/rouge.scss` and `/_sass/rouge-dark.scss`. (Rouge transform code to html elements, but don't do css stylesheet itself; you have to choose a css theme for rouge.)

## Feature tests
Feature tests are with [modernizr.js](https://github.com/Modernizr/Modernizr), which is more robust and doesn't discriminate users by their 'User Agent' String. Users don't need to fake a `User Agent` string to get modern features; support for modern features are done with basic sanity checks instead. (These are really basic; if you don't pass these checks you are sure to not properly support such feature)

## Preferences
I added a "Site Preferences" page (a link is given at the header on the top), which lists some settings that can be tweaked. Site preferences requires support for `localStorage`; a big fat red warning will be shown if support for `localStorage` is not found.

### Selecting font family and font size
Font family and font size can be tweaked at the preferences page. This site features the "Bitter" font for sans-serif fonts and "Source Code Pro" for monospace fonts, but a few system font fallback options are also provided. For advanced tweaks, you should look for some kind of WebExtensions instead, like [Stylus](https://github.com/openstyles/stylus).

### Manually selecting dark mode
You can manually select dark mode or light mode in the preferences page.